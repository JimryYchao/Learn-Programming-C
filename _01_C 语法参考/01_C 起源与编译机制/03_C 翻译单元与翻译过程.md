## C 翻译单元与翻译过程

---
### 翻译单元

对于 C 源文件来讲，经过 ```#include``` 预处理之后的文件称之为 **翻译单元**，即一个源文件与它包含的头文件。

---
### 编译器翻译文件的阶段

在遇到语法错误的下列任何翻译阶段，编译器会发出警告或错误。链接器会解析所有外部引用，并通过将一个或多个单独处理的翻译单元与标准库组合在一起来创建可执行程序或 DLL。

#### 字符映射

源文件中的字符将映射到 **内部源表示形式**（源字符集，包含空白字符、英文、数字与 29 个标点符号共 96 个字符）。在此阶段，三元组序列（又称三标符）将转换为单字符内部表示形式。

#### 行拼接

以反斜杠结尾的所有行 ```\``` 后跟换行符，将与源文件中的下一行进行联接，从而形成物理行的逻辑行。如果源文件不为空，则该文件必须以不带有反斜杠的换行符结尾。

#### 词汇切分

词汇分析时分为 **预处理标记分析** 和 **空白字符替换注释**。源文件中的注释将逐一替换为空白字符，并将所有注释从程序中移除。换行符将保留。预处理标记有头文件名、预处理标识符、预处理常量、预处理运算符、不属于任何其他类别的单独非空白字符。
词汇分析时可能会出现 **最大吞噬现象**（maximal munch）：若已经分析输入为到给定字符为止的预处理记号，则通常将能构成一个预处理记号的最长字符序列处理成下个预处理记号，即这会导致后继分析失败。

```c
int foo = 1;
int bar = 0xE+foo;   	// ERROR: 非法的预处理数字 0xE+foo
int baz = 0xE + foo;

int quux = bar+++++baz; // ERROR: bar++ ++ +baz，而非 bar++ + ++baz
```

#### 预处理

此阶段将执行预处理指令，并且 **宏展开** 到源文件中：```#include``` 语句调用所有包含的文本上的三个翻译步骤开始的翻译；全部预处理结束后，从源码中移除所有预处理指令。

#### 字符集映射

所有源字符集成员和转义序列将转换为执行字符集中的等效项。对于 Microsoft C 和 C++，源和执行字符集都为 ASCII。

#### 字符串串联

**所有相邻字符串和宽字符串文本是串联的**。例如，```"String ""concatenation"``` 串联为 `"String concatenation"`。

#### 翻译

**发生编译**：按照语法和语义分析记号，并将它们翻译成翻译单元。

#### 链接

**发生链接**：将翻译单元和满足外部引用所需的库组件汇集成程序映像（解析所有外部引用以创建可执行程序或动态链接库），它含有在其执行环境（操作系统）中执行所需的信息。

---