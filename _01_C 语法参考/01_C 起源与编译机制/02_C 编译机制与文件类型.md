## C 编译机制与文件类型

---
### 源文件编程过程中出现的文件类型

#### 头文件

每个 C/C++ 程序通常由头文件（header files，```*.h```）和及其源代码文件组成。头文件作为一种包含功能函数、数据接口声明的载体文件，主要用于保存程序的声明；源代码文件用于保存程序的实现。

#### 源代码文件

用 C 语言编写程序时，编写的内容被储存在文本文件中，该文件被称为源代码文件（source code files，```*.c```）。

#### 目标代码文件

编译器把源代码转换为机器语言代码，并把结果放在与源文件相同名称的目标代码文件中，其拓展名为 ```*.o```，但是并不能直接运行该文件。目标代码文件缺失启动代码 (startup code)，启动代码充当着程序和操作系统之间的接口。

#### 库文件

目标代码还缺少库函数，几乎所有的 C 程序都要使用 C 标准库中的函数。当生成完整的可执行程序，之后会将中间代码的目标代码文件删除。
`helloworld.c` 中就使用了 ```printf()``` 函数。目标代码文件并不包含该函数的代码，它只包含了使用 ```printf()``` 函数的指令。```printf()``` 函数真正的代码储存在另一个被称为库的文件中。库文件中有许多函数的目标代码。

#### 可执行文件

可执行文件（executable file）指的是可以由操作系统进行加载执行的文件。在 win 系统下，可执行程序可以是 ```*.exe```、```*.sys```、```*.com``` 等类型文件。C 程序由 C 源文件经 C 编译器编译生成。

---
### 编译器与链接器

#### 编译器的作用

C 编程的基本策略是，用程序把源代码文件转换为可执行文件（其中包含可直接运行的机器语言代码）。编译器把源代码转换成中间代码，链接器把中间代码和其他代码合并，生成可执行文件。
C 使用这种分而治之的方法方便对程序进行模块化，可以独立编译单独的模块，稍后再用链接器合并已编译的模块。通过这种方式，如果只更改某个模块，不必因此重新编译其他模块。

#### 链接器的作用

链接（Link）其实是一个 “打包” 的过程，它将所有二进制形式的 **目标文件**（程序的目标代码和依赖的库文件）和 **系统组件**（例如系统的标准启动代码）组合成一个可执行文件。利用的工具是链接器。
目标文件和可执行文件都由机器语言指令组成的。

#### 编译过程演示

![编译过程](../../.img/编译过程.png)

---
### 语言编译过程

编译共分为四个阶段: 预处理阶段、编译阶段、汇编阶段、链接阶段。

 ```powershell
1. main.c (源文件)
	>>>  经预处理阶段生成 main.i
2. main.i (预处理之后的文件)
	>>>  经编译器编译阶段生成 main.s
3. main.s (汇编程序)
	>>>  经汇编器汇编阶段生成 main.o
4. main.o (可重定位目标程序)
	>>>  与 printf.o、other.o 等库文件经链接器链接阶段生成 a.out (可执行目标程序)
```

#### 预处理阶段

```powershell
# 生成预处理后的代码
 $ gcc -E main.c -o hello.i
```

预处理指令包括条件编译、源文件包含、宏替换、行控制、抛错、杂注和空指令：

- **条件编译**：条件编译的功能是根据条件有选择性的保留或者放弃源文件中的内容。常见的条件包含以 ```#if```，```#ifdef```，```#ifndef``` 指令开始，以 ```#endif``` 结束。```#undef``` 指定对 ```#define``` 定义的标识符取消定义。
- **源文件包含**：源文件包含指令的功能是搜索指定的文件，并将它的内容包含（```#include```）在进来，放在当前所在的位置。源文件包含有两种，系统文件和用户定义文件。
- **宏替换**：宏的作用是把一个标识符指定为其他一些成为替换列表的预处理记号，但这个标识符出现在之后的文本中时，将用对应的预处理记号把它替换掉。宏的本质是替换，分为有参与无参两种。
- **行、编译阶段控制**：含控制指令以 ```#line``` 引导，用于改变定义宏 ```_LINE_``` 的值，如果后面的字符串存在，则改变 ```_FILE_``` 的值。
- **抛错**：抛错指令以 ```#error``` 引导，用于在预处理期间发出一个诊断信息，再停止转换。抛错是人为的行为。
- **杂注**：杂注指令用于向 C 实现传递额外的信息（编译选项），对程序的某些方面进行控制，以 ```#pragma``` 引导。
- **空指令**：只有一个 ```#```，自成一行，没有实际的效用。

> 预处理阶段将头文件 ```*.h``` 的内容插入到 ```#include``` 的位置，同时删除注释行，添加行号与文件名标识；```*.i``` 文件是不包含宏定义的。

#### 编译阶段

```powershell
# 生成汇编文件
 $ gcc -S main.c -o hello.s
```

编译是将源文件 ```hello.i``` 翻译成汇编文件 ```hello.s``` 的过程。其中包含词法、语法分析等步骤。

#### 汇编阶段

```powershell
# 生成目标代码
 $ gcc -c main.c -o hello.o
```

汇编阶段是把编译阶段生成的 ```*.s``` 文件转成 ```*.o``` 的二进制目标代码。汇编器（as）将 ```hello.s``` 翻译成机器语言指令，把这些指令打包成重定位目标程序的格式，并将结果保存在目标文件 ```hello.o``` 中。```hello.o``` 文件是一个二进制文件，字节编码是机器语言指令而不是字符。

#### 链接阶段

```powershell
# 生成可执行目标程序
 $ gcc main.c -o a.out
```

链接阶段把汇编后的机器指令集变成可以直接运行的文件，对目标文件进行链接是因为在目标文件中可能用到了其他文件当中定义的字段或函数，通过链接把多个不同的目标文件关联在一起。链接器（ld）负责处理多个文件的合并，生成一个可执行文件。

---